<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>Global Covid-19 Vaccine Apartheid</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <!-- Leaflet CSS -->
    <link
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
      rel="stylesheet"
    />
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css?family=Work+Sans:400,500,600"
      rel="stylesheet"
      type="text/css"
    />
    <!-- CSS stylesheet-->
    <link
      href="css/styles.css"
      rel="stylesheet"
    />

  </head>

  <body>
    <div class="container-fluid">
      <header class="row bg-dark text-white py-2">
        <div class = "col">
          <h1>Global Covid-19 Vaccine Apartheid</h1>
        </div>
      </header>

    <section class="row">
      <div class="col-md-8 col-lg-8 col-xl-8 order-md-2 px-0">
        <div id="map"></div>
      </div>
      <aside id="about"
        class="col-md-4 col-lg-4 col-xl-4 order-md-1 text-black py-2 pl-4 overflow-auto">
        <section>
          <h1>A Deadly 'Pathology of Power'</h1>
            <p>
              <u>How to use this visualization</u>
              <br>
              Hover over the map to see a snapshot of vaccination trends.
            </p>
            <p>
              Click the dropdown menu to discern whether WTO members support or oppose a temporary suspension of certain intellectual property rules
              to boost the global supply of jabs, tests, and treatments—first proposed by India and South Africa on October 2, 2020, when the pandemic death toll
              had just surpassed 1 million—and to explore where untapped vaccine production potential exists.
            </p>
            <p>
              <u>Background</u>
              <br>
              Will add more later
            </p>
            <p>
              <u>Sources</u>
              <br>
              <a href='https://github.com/owid/covid-19-data/tree/master/public/data' target="blank"> Vaccination rates</a> came courtesy of Our World in Data
              - see Mathieu, E., Ritchie, H., Ortiz-Ospina, E. et al. A global database of COVID-19 vaccinations. Nat Hum Behav (2021); Information about whether
              governments <a href='https://msfaccess.org/no-patents-no-monopolies-pandemic' target="blank"> support or oppose the TRIPS waiver proposal</a> supplied by Doctors Without Borders;
              Data on <a href='https://www.hrw.org/news/2021/12/15/experts-identify-100-plus-firms-make-covid-19-mrna-vaccines' target="blank"> untapped vaccine production potential</a>
              compiled by Doctors Without Borders and the AccessIBSA project. <a href='https://www.naturalearthdata.com/downloads/50m-cultural-vectors/' target="blank">National boundaries</a>
              and <a href='https://gavinr.com/open-data/world-countries-centroids/' target="blank">country centroids</a> provided by Natural Earth and Gavin Rehkemper, respectively.
            </p>
        </section>
      </aside>
    </section>

    <footer class="row bg-dark text-white py-1">
      <ul class="list-unstyled">
        <div class="col-12 text-center text-white pt-2">
            Map authored by <a href="https://kwstancil.github.io/map-portfolio/">Kenny Stancil</a>
        </div>
      </ul>
    </footer>
    </div>

    <!-- create legend -->
    <div class="bg-secondary py-2 px-3 ml-3 mt-3 text-white" id="legend"></div>
    <!-- create dropdown -->
    <div id="ui" class="dropdown">
      <button class="btn btn-secondary dropdown-toggle">Sharing knowledge or hoarding it?</button>
      <div id="myDropdown" class="dropdown-content">
        <a id="addContent1">Supports TRIPS waiver</a>
        <a id="addContent2">Opposes TRIPS waiver</a>
        <a id="addContent3">Unknown position on TRIPS waiver</a>
        <a id="addContent4">Idle mRNA manufacturing capacity</a>
      </div>
    </div>

    <!-- Add Bootstrap -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
      crossorigin="anonymous">
    </script>
    <!-- then Leaflet JS -->
    <script
      src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
      integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
      crossorigin="">
    </script>

    <!-- then Papa Parse
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.1/papaparse.min.js"
      integrity="sha512-EbdJQSugx0nVWrtyK3JdQQ/03mS3Q1UiAhRtErbwl1YL/+e2hZdlIcSURxxh7WXHTzn83sjlh2rysACoJGfb6g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer">
    </script>

    then Chroma
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.1.2/chroma.min.js"
      integrity="sha512-8TVPS0EFkkmtT6yPb5K4csnSt3tjbKRrs0F8gvTNKv2OxOcwDO7+Klkz86gMVrzfqtZos5N2a+k+r9D+hlccmQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer">
    </script> -->

    <!-- then Simple Statistics -->
	   <script
     src='https://unpkg.com/simple-statistics@7.7.0/dist/simple-statistics.min.js'>
   </script>
    <!-- then D3 -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.1.1/d3.min.js"
      integrity="sha512-COTaPOlz12cG4fSfcBsxZsjauBAyldqp+8FQUM/dZHm+ts/jR4AFoJhCqxy8K10Jrf3pojfsbq7fAPTb1XaVkg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer">
    </script>
    <!-- then Topojson -->
    <script src="https://unpkg.com/topojson@3"></script>
    <!-- then app.js -->
    <script src ="js/app.js"></script>

    <script>
    // map options
    const options = {
      scrollWheelZoom: true,
      zoomSnap: 0.1,
      dragging: true,
      zoomControl: false,
      };

    // create the Leaflet map
    const map = L.map("map", options);

    map.fitBounds([[57.39, 196.74], [-48.13, -191.64]]) // use map.getBounds in developer tools to find diagonal corners on the bounding rectangle

    // request tiles and add to map
    const tiles = L.tileLayer(
      "http://{s}.tile.stamen.com/toner-lite/{z}/{x}/{y}.{ext}", {
        attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        subdomains: "abcd",
        ext: "png",
      }
    ).addTo(map);

    // set global variable for map
    const normValue = "owid_covid_latest_people_fully_vaccinated_per_hundred";

    const vaxRate = fetch('data/vaccination_rate.json')
      .then(response => response.json())

    const tripsWaiver = fetch('data/support_trips_waiver.geojson')
      .then(response => response.json())

    const idleProd = fetch('data/idle_production_capacity.geojson')
      .then(response => response.json())

    Promise.all([vaxRate, tripsWaiver, idleProd])
      .then(responses => {
        console.log(responses)
        drawMap(responses);
      })

    // AJAX request for GeoJSON data
    fetch('data/vaccination_rate.json')
      // after it is returned...
      .then(function (response) {
        // if has a property called ok, and it is true
        if (response.ok) {
          // The API call was successful!
          // Parse the JSON into a useable format, then return it
          return response.json();
        } else {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
      })
      // The returned response is now data in a new then method
      .then(function (data) {
        // This is the JSON from our response
        console.log(data);
        // Pass the data to the drawMap function
        // drawMap(data);
      });

    function drawMap(data) {

      let [vaxRate, tripsWaiver, idleProd] = data; // alt syntax to destructure an array

      console.log(vaxRate, tripsWaiver, idleProd, data)

      // Use Leaflet's L.geoJson() method to convert our GeoJSON data into a Leaflet object
      const vaxrate = L.geoJson(vaxRate, {
        // style nations with initial default path options
        style: function (feature) {
          return {
            color: "#20282e",
            weight: 2,
            fillOpacity: 1,
          };
        },

        // add hover/touch functionality to each feature layer
        onEachFeature: function (feature, layer) {
          // when mousing over a layer
          layer.on("mouseover", function () {
            // change the stroke color and bring that element to the front
            layer
              .setStyle({
                color: "#ff6e00",
              })
              .bringToFront();
          });

          // on mousing off layer
          layer.on("mouseout", function () {
            // reset the layer style to its original stroke color
            layer.setStyle({
              color: "#20282e",
            });
          });
        },
      }).addTo(map);

      // create empty feature group to contain layers added by dropdown menu clicks
      const mapLayers = L.featureGroup().addTo(map);

      const yesWaiver = L.geoJson(tripsWaiver, {

        pointToLayer: function(feature, latlng) {

          const waiverProp = feature.properties.TRIPS_WAIVER;

          if(waiverProp == 1) {
            return new L.CircleMarker(latlng, {
              radius: 5,
              fillOpacity: 1,
              color: "#006913"
            });
          }
        }
      });

      const noWaiver = L.geoJson(tripsWaiver, {

        pointToLayer: function(feature, latlng) {

          const waiverProp = feature.properties.TRIPS_WAIVER;

          if(waiverProp == 0) {
            return new L.CircleMarker(latlng, {
              radius: 5,
              fillOpacity: 1,
              color: "#db0909"
            });
          }
        }
      });

      const unknownWaiver = L.geoJson(tripsWaiver, {

        pointToLayer: function(feature, latlng) {

          const waiverProp = feature.properties.TRIPS_WAIVER;

          if(waiverProp == 2) {
            return new L.CircleMarker(latlng, {
              radius: 5,
              fillOpacity: 1,
              color: "#f7eb40"
            });
          }
        }
      });

      const vaxFactories = L.geoJson(idleProd, {

        pointToLayer: function(feature, latlng) {

          const prodProp = feature.properties.FACTORIES;

          if(prodProp != null) {
            return new L.CircleMarker(latlng, {
              radius: 5,
              fillOpacity: 1,
              color: "#a72afa"
            });
          }
        }
      });

      // define dropdown menu items by their id values
      const ui = document.querySelector("#ui");
      const addContent1 = document.querySelector("#addContent1");
      const addContent2 = document.querySelector("#addContent2");
      const addContent3 = document.querySelector("#addContent3");
      const addContent4 = document.querySelector("#addContent4");

      // define what happens when a user clicks on dropdown menu items
      ui.addEventListener("click", function (e) {
  		  document.getElementById("myDropdown").classList.toggle("show");
  		});

      // supports TRIPS wavier
      addContent1.addEventListener("click", function (e) {
        // remove all layers from mapLayers
        mapLayers.clearLayers();
        // then add the selected layer
        mapLayers.addLayer(yesWaiver);
  		});

      // opposes TRIPS wavier
      addContent2.addEventListener("click", function (e) {
        // remove all layers from mapLayers
        mapLayers.clearLayers();
        // then add the selected layer
        mapLayers.addLayer(noWaiver);
  		});

      // unknown position on TRIPS wavier
      addContent3.addEventListener("click", function (e) {
        // remove all layers from mapLayers
        mapLayers.clearLayers();
        // then add the selected layer
        mapLayers.addLayer(unknownWaiver);
  		});

      // idle mRNA manufacturing capacity
      addContent4.addEventListener("click", function (e) {
        // remove all layers from mapLayers
        mapLayers.clearLayers();
        // then add the selected layer
        mapLayers.addLayer(vaxFactories);
  		});

      //const factoryProp = feature.properties.FACTORIES

      //  let tooltipFactories = ''
      //    if (factoryProp.ADMIN) {
            //build the tooltip
      //      tooltip = `<b>${props['ADMIN']}</b><br />`
      //    }

      //    if (factoryProp[FACTORIES] != 'null') {
      //      tooltip += `${(factoryProp[FACTORIES])} factories with the potential to make mRNA vaccines<br />`
      //    };

        updateMap(vaxrate);

      } // end drawMap()

    function updateMap(vaxrate) {
      // get the class breaks for the current data attribute
			const breaks = getClassBreaks(vaxrate);

			// loop through each vaxrate layer to update the color and tooltip info
			vaxrate.eachLayer(function (layer) {
				const props = layer.feature.properties;

				// set the fill color of layer based on its normalized data value
				layer.setStyle({
					fillColor: getColor(props[normValue], breaks),
				});

				// assemble string sequence of info for tooltip (end line break with + operator)
				let tooltipInfo = ''
        if (props.ADMIN) {
          //build the tooltip
        tooltip = `<b>${props['ADMIN']}</b><br />`
        }

        if (props[normValue] != 'null') {
          tooltip += `${(props[normValue])}% fully inoculated<br />
          ${(props["owid_covid_latest_people_vaccinated_per_hundred"])}% partially inoculated<br />
          ${(props["owid_covid_latest_total_boosters_per_hundred"])} booster shots administered per 100 people`;
        } else {
          tooltip += 'No data available'
        }

				// bind tooltip to layer
			  layer.bindTooltip(tooltip, {
				 // sticky property so tooltip follows the mouse
				 sticky: true,
			  });
			});

      // update the legend with the current data attribute information
			addLegend(breaks);

		} // end updateMap

    // Get class breaks in data
		function getClassBreaks(vaxrate) {
  		// create empty Array for storing values
  		const values = [];

  		// loop through all the vaxrates
  		vaxrate.eachLayer(function (layer) {
    		let value =
      		layer.feature.properties[normValue];
    		values.push(value); // push the normalized value for each layer into the Array
  		});
      console.log(values);

  		// determine similar clusters
  		const clusters = ss.ckmeans(values, 5);

  		// create an array of the lowest value within each cluster
  		const breaks = clusters.map(function (cluster) {
    		return [cluster[0], cluster.pop()];
  		});

  		//return array of arrays, e.g., [[0.24,0.25], [0.26, 0.37], etc]
  		return breaks;
		} // end getClassBreaks

    // Get color of country
		function getColor(d, breaks) {
		  // function accepts a single normalized data attribute value
		  // and uses a series of conditional statements to determine which
		  // which color value to return to return to the function caller

		  if (d <= breaks[0][1]) {
		    return "#f1eef6";
		  } else if (d <= breaks[1][1]) {
		    return "#bdc9e1";
		  } else if (d <= breaks[2][1]) {
		    return "#74a9cf";
		  } else if (d <= breaks[3][1]) {
		    return "#2b8cbe";
		  } else if (d <= breaks[4][1]) {
		    return "#045a8d";
      }
		} // end getColor

    // Add legend to map
    function addLegend(breaks) {
      // check console to verify breaks array
      console.log(breaks);

        // create a new Leaflet control object, and position it top left
        const legendControl = L.control({ position: "bottomleft"});

        // when the legend is added to the map
        legendControl.onAdd = function () {
          // select a div element with an id attribute of legend
          const legend = L.DomUtil.get("legend");

          // disable scroll and click/touch on map when on legend
          L.DomEvent.disableScrollPropagation(legend);
          L.DomEvent.disableClickPropagation(legend);

          // return the selection to the method
          return legend;
        };

        // add the empty legend div to the map
  		  legendControl.addTo(map);
				updateLegend(breaks);

    } //end addLegend

    function updateLegend(breaks) {
			// select the legend, add a title, begin an unordered list and assign to a variable
			const legend = document.querySelector("#legend")
			legend.innerHTML = `<b><u>${"Share of population fully vaccinated"}</b></u><br />`

			// loop through the Array of classification break values
			for (let i = 0; i <= breaks.length - 1; i++) {
				let color = getColor(breaks[i][0], breaks);

				legend.innerHTML +=
					`<div><span style="background:${color}"></span>
					<label>${(breaks[i][0])}% &mdash;
					${(breaks[i][1])}%</label></div>`
			}
		}

    </script>
  </body>
</html>
